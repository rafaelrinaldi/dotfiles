#!/bin/bash
# Smart GitHub credential helper that picks the right account based on repo owner
# Used by: [credential "https://github.com"] helper = !~/.config/git/git-credential-resolver

# Read the credential request from stdin
while IFS='=' read -r key value; do
  case "$key" in
    protocol) protocol="$value" ;;
    host) host="$value" ;;
    path) path="$value" ;;
  esac
done

# Only handle github.com
if [[ "$host" != "github.com" ]]; then
  exit 1
fi

# Extract owner from path (e.g., "owner/repo.git" -> "owner")
owner="${path%%/*}"

# Personal GitHub username and token
PERSONAL_USER="{{ .github_user_personal }}"
PERSONAL_TOKEN="{{ .github_token_personal }}"

# Work GitHub username and token
WORK_USER="{{ .github_user_work }}"
WORK_TOKEN="{{ .github_token_work }}"

# Pick credentials based on repo owner
if [[ "$owner" == "$PERSONAL_USER" ]]; then
  echo "protocol=https"
  echo "host=github.com"
  echo "username=$PERSONAL_USER"
  echo "password=$PERSONAL_TOKEN"
else
  # Default to work account for everything else (work repos, org repos, etc.)
  echo "protocol=https"
  echo "host=github.com"
  echo "username=$WORK_USER"
  echo "password=$WORK_TOKEN"
fi
