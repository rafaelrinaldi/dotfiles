#!/bin/bash

set -euo pipefail

echo "üîë Setting up Bitwarden authentication..."

if ! bw status | grep -q "authenticated"; then
    echo "Please log in to Bitwarden:"

    sesh=$(bw login --raw)

    if [[ -z "$sesh" ]]; then
        echo "‚ùå Bitwarden login failed. No session key."
        exit 1
    fi

    export BW_SESSION="$sesh"

    echo "Login successful." # Indicate login was achieved
fi

if ! bw status | grep -q "unlocked"; then
    echo "Please unlock your Bitwarden vault:"

    sesh=$(bw unlock --raw)

    if [[ -z "$sesh" ]]; then
        echo "‚ùå Bitwarden unlock failed. No session key."
        exit 1
    fi

    export BW_SESSION="${sesh:-$BW_SESSION}"

    echo "Vault unlocked."
fi

echo "‚úÖ Bitwarden authenticated and ready"

if [[ -z "${BW_SESSION:-}" ]]; then
    echo "‚ö†Ô∏è Warning: BW_SESSION variable is not set or empty."
fi
